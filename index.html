<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>写真整理ツール</title>
  
  <!-- 外部ライブラリ (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
  
  <!-- CSSファイルの読み込み -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ドラッグ用オーバーレイ -->
<div class="drop-overlay"></div>

<header>
  <h1><i data-lucide="file-check"></i> 画像PDF結合ツール</h1>
  <div class="header-controls">
    <button id="themeToggleBtn" class="btn-icon" title="テーマ切り替え">
      <i data-lucide="sun" id="themeIcon"></i>
    </button>
  </div>
</header>

<div class="app-layout">
  <!-- 左側：メインコンテンツ -->
  <main class="main-content">
    <div class="toolbar">
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('folderInput').click()">
        <i data-lucide="folder-open" size="16"></i> フォルダを開く
      </button>
      <input type="file" id="folderInput" webkitdirectory multiple accept="image/*" style="display:none">
      
      <button class="btn btn-secondary btn-sm" onclick="clearAll()">
        <i data-lucide="trash-2" size="16"></i> 全削除
      </button>
      
      <div style="flex:1"></div>
      <span style="font-size:13px; color:var(--text-sub);" id="countDisplay">0 枚の画像</span>
    </div>

    <!-- 画像処理ツールバー -->
    <div class="processing-toolbar">
      <div class="proc-group">
        <div class="proc-title"><i data-lucide="scissors" size="14"></i> トリミング・加工</div>
        <div class="proc-buttons">
          <button id="pickColorBtn" class="btn btn-purple btn-sm" disabled title="画像から色を取得">
            <i data-lucide="pipette" size="14"></i> スポイト
          </button>
          <button id="redBoxBtn" class="btn btn-red-outline btn-sm" disabled title="赤枠またはマスクを一括設定">
            <i data-lucide="square" size="14"></i> 枠/マスク
          </button>
          <button id="autoCropBtn" class="btn btn-outline-success btn-sm" disabled title="現在のスライダー設定で再処理">
            <i data-lucide="refresh-cw" size="14"></i> 適用
          </button>
          <button id="resetProcBtn" class="btn btn-secondary btn-sm" disabled onclick="resetAllProcessing()" title="すべての処理をリセット">
            <i data-lucide="rotate-ccw" size="14"></i> リセット
          </button>
        </div>
      </div>
      
      <!-- スライダー表示切替ボタン -->
      <button id="toggleSlidersBtn" class="btn btn-secondary btn-sm" title="トリミング感度設定を表示">
        <i data-lucide="sliders-horizontal" size="14"></i> 感度調整
      </button>
    </div>

    <!-- スライダーパネル（初期状態はhidden） -->
    <div id="sliderPanel" class="slider-panel hidden">
      <div class="proc-sliders">
        <!-- Hue -->
        <div class="dual-slider-container">
          <div class="slider-value"><span>色相(H)</span> <span id="val-h">35 - 90</span></div>
          <div class="dual-slider" id="slider-h">
            <div class="slider-track"></div><div class="slider-range"></div>
            <div class="thumb thumb-min"></div><div class="thumb thumb-max"></div>
            <input type="range" class="range-input input-min" min="0" max="180" value="35">
            <input type="range" class="range-input input-max" min="0" max="180" value="90">
          </div>
        </div>
        <!-- Sat -->
        <div class="dual-slider-container">
          <div class="slider-value"><span>彩度(S)</span> <span id="val-s">40 - 255</span></div>
          <div class="dual-slider" id="slider-s">
            <div class="slider-track"></div><div class="slider-range"></div>
            <div class="thumb thumb-min"></div><div class="thumb thumb-max"></div>
            <input type="range" class="range-input input-min" min="0" max="255" value="40">
            <input type="range" class="range-input input-max" min="0" max="255" value="255">
          </div>
        </div>
        <!-- Val -->
        <div class="dual-slider-container">
          <div class="slider-value"><span>明度(V)</span> <span id="val-v">40 - 255</span></div>
          <div class="dual-slider" id="slider-v">
            <div class="slider-track"></div><div class="slider-range"></div>
            <div class="thumb thumb-min"></div><div class="thumb thumb-max"></div>
            <input type="range" class="range-input input-min" min="0" max="255" value="40">
            <input type="range" class="range-input input-max" min="0" max="255" value="255">
          </div>
        </div>
      </div>
    </div>

    <div class="scroll-area">
      <div id="previewGrid" class="preview-grid is-empty">
        <div class="empty-state">
          <div class="drop-message" onclick="document.getElementById('folderInput').click()">
            <i data-lucide="image-plus" size="64" style="margin-bottom:16px; color:var(--text-sub);"></i>
            <p style="font-size: 16px; font-weight: 500; color: var(--text-sub);">
              フォルダごとここにドロップ<br>
              <span style="font-size: 13px; font-weight: 400; color: var(--text-sub);">またはクリックして選択</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 右側：サイドバー -->
  <aside class="sidebar">
    
    <!-- PDF作成アクション -->
    <div class="sidebar-section">
      <div class="sidebar-title"><i data-lucide="file-output"></i> 出力アクション</div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="margin-bottom:8px;">出力モード</label>
        <div class="radio-list">
          <label class="radio-item">
            <input type="radio" name="outputMode" value="pdf-image" checked>
            <span>PDF (中身を画像化) <small style="color:var(--text-sub); margin-left:4px;">推奨</small></span>
          </label>
          <label class="radio-item">
            <input type="radio" name="outputMode" value="pdf-text">
            <span>PDF (テキスト保持)</span>
          </label>
          <label class="radio-item">
            <input type="radio" name="outputMode" value="image-file">
            <span>画像ファイル (JPG/ZIP)</span>
          </label>
        </div>
      </div>

      <button id="generateBtn" class="btn btn-primary" disabled>
        <i data-lucide="download"></i> 保存を実行
      </button>
      <button id="openFlowBtn" class="btn btn-secondary" onclick="openCsvFlowModal()">
        <i data-lucide="folder-tree"></i> 写真振分フローを表示
      </button>
    </div>

    <!-- PDFレイアウト設定 -->
    <div class="sidebar-section">
      <div class="sidebar-title"><i data-lucide="settings-2"></i> レイアウト設定</div>
      <div class="form-group">
        <label>用紙サイズ</label>
        <select id="pageSize" class="form-control">
          <option value="a4">A4</option>
          <option value="a3" selected>A3</option>
        </select>
      </div>
      <div class="form-group">
        <label>向き</label>
        <select id="orientation" class="form-control">
          <option value="portrait">縦</option>
          <option value="landscape" selected>横</option>
        </select>
      </div>
      <div class="form-group">
        <label>1ページあたりの枚数</label>
        <select id="imagesPerPage" class="form-control">
          <option value="1">1枚</option>
          <option value="2">2枚</option>
          <option value="4" selected>4枚</option>
          <option value="6">6枚</option>
          <option value="9">9枚</option>
        </select>
      </div>
      <div class="form-group">
        <label>余白 (mm)</label>
        <input type="number" id="margin" value="10" min="0" max="50" class="form-control">
      </div>
    </div>

    <!-- PDFプレビュー -->
    <div class="sidebar-section" style="border-bottom:none;">
      <div class="sidebar-title"><i data-lucide="eye"></i> レイアウト確認</div>
      <div class="pdf-preview-box">
        <div id="pdfPage" class="pdf-page-preview portrait"></div>
      </div>
    </div>
  </aside>
</div>

<!-- ステータスバー -->
<div id="statusBar" class="status-bar">
  <div class="spinner"></div><span id="statusText">処理中...</span>
</div>

<!-- 画像プレビュー＆操作モーダル -->
<div class="modal-overlay" id="previewModal">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
    <div style="padding:12px 16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
      <h3 style="font-size:16px; margin:0;" id="previewModalTitle">画像プレビュー</h3>
      <button onclick="closeModal('previewModal')" style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-main);">&times;</button>
    </div>
    <div class="modal-body" style="background: #0f172a; display: flex; align-items: center; justify-content: center;">
      <img id="previewModalImage" src="" alt="プレビュー" style="max-width: 100%; max-height: 60vh; object-fit: contain;">
    </div>
    <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; justify-content: space-between; align-items: center; background: var(--bg-modal-footer);">
      <div>
        <button class="btn btn-danger" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="removeImageFromPreview()">
          <i data-lucide="trash-2" size="16"></i> 削除
        </button>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="previewUndoBtn" class="btn btn-secondary" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="undoEditFromPreview()">
          <i data-lucide="rotate-ccw" size="16"></i> 元に戻す
        </button>
        <button class="btn btn-primary" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="openManualCropFromPreview()">
          <i data-lucide="scissors" size="16"></i> 手動トリミング
        </button>
        <button class="btn btn-secondary" style="width: auto; padding: 8px 16px; font-size: 13px;" onclick="closeModal('previewModal')">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>

<!-- トリミング編集モーダル -->
<div class="modal-overlay" id="cropModal">
  <div class="modal-content">
    <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
      <h3 style="font-size:16px; margin:0;">手動トリミング</h3>
      <button onclick="closeModal('cropModal')" style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-main);">&times;</button>
    </div>
    <div class="modal-body">
      <img id="cropTarget" src="" alt="" class="cropper-target">
    </div>
    <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px; background:var(--bg-modal-footer);">
      <button class="btn btn-secondary" style="width:auto;" onclick="closeModal('cropModal')">キャンセル</button>
      <button class="btn btn-primary" style="width:auto;" onclick="applyManualCrop()">適用</button>
    </div>
  </div>
</div>

<!-- スポイト用モーダル -->
<div class="modal-overlay" id="pickModal">
  <div class="modal-content">
    <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
      <h3 style="font-size:16px; margin:0;">🎨 黒板の色を選択</h3>
    </div>
    <div class="modal-body">
      <div class="modal-instruction">黒板の部分をクリックしてください</div>
      <div class="img-container pick-cursor" style="height:100%; width:100%; display:flex; align-items:center; justify-content:center;">
        <img id="pickImage" src="" alt="色選択">
      </div>
    </div>
    <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px; background:var(--bg-modal-footer);">
      <button class="btn btn-secondary" onclick="closePickModalAndRun(false)">スキップ（デフォルト設定で実行）</button>
    </div>
  </div>
</div>

<!-- 赤枠編集用モーダル（機能拡張版） -->
<div class="modal-overlay" id="redBoxModal">
  <div class="modal-content" style="max-width:1000px; height:90vh;">
    <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
      <h3 style="font-size:16px; margin:0;">🔴 枠の一括追加設定（1枚目で指定）</h3>
      <button class="btn btn-secondary" style="width:auto; padding:4px 8px; font-size:12px;" onclick="clearRedBoxes()">
        <i data-lucide="trash"></i> 枠を全消去
      </button>
    </div>
    
    <!-- 手動編集ツールバー -->
    <div class="manual-controls">
      <div style="margin-right:16px; display:flex; gap:12px; align-items:center;">
        <label class="toggle-switch" title="枠外を色で塗りつぶします">
          <input type="checkbox" id="maskModeCheck" checked> <!-- Default Checked -->
          <span>枠外を塗りつぶす (マスク)</span>
        </label>
        <div style="display:flex; align-items:center; gap:4px;">
           <span>色:</span>
           <input type="color" id="maskColorInput" value="#ffffff" style="border:none; width:24px; height:24px; cursor:pointer;">
        </div>
      </div>
      <div style="width:1px; height:20px; background:var(--border-color); margin:0 8px;"></div>
      <div class="manual-input-group">
        <span>X:</span><input type="number" id="rbX" class="manual-input" min="0">
        <span>Y:</span><input type="number" id="rbY" class="manual-input" min="0">
        <span>W:</span><input type="number" id="rbW" class="manual-input" min="0">
        <span>H:</span><input type="number" id="rbH" class="manual-input" min="0">
        <button onclick="updateRedBoxFromInputs()" class="btn btn-secondary" style="width:auto; padding:4px 8px; margin:0 0 0 4px; font-size:12px;">更新</button>
      </div>
    </div>

    <div class="modal-body" id="redBoxBody" style="background:#333; overflow:hidden;">
      <div class="modal-instruction">ドラッグして枠を追加 (Ctrl+Zで戻る)</div>
      <!-- 画像とCanvasを重ねるコンテナ -->
      <div style="position:relative; display:inline-block;" id="redBoxContainer">
        <img id="redBoxTargetImage" style="display:block; max-width:100%; max-height:80vh; pointer-events:none;">
        <canvas id="redBoxCanvas" style="position:absolute; top:0; left:0;"></canvas>
      </div>
    </div>
    <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px; background:var(--bg-modal-footer);">
      <button class="btn btn-secondary" style="width:auto;" onclick="closeModal('redBoxModal')">キャンセル</button>
      <button class="btn btn-primary" style="width:auto;" onclick="applyRedBoxesToAll()">全画像に適用</button>
    </div>
  </div>
</div>

<!-- CSV振分フローモーダル -->
<div class="modal-overlay" id="csvFlowModal">
  <div class="modal-content" style="max-width:640px; max-height:90vh;">
    <div style="padding:16px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
      <h3 style="font-size:16px; margin:0; display:flex; align-items:center; gap:8px;">
        <i data-lucide="folder-tree" size="20"></i> 写真振分フロー
      </h3>
      <button onclick="closeModal('csvFlowModal')" style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-main);">&times;</button>
    </div>
    <div style="padding:20px; overflow-y:auto; flex:1;">
      <!-- Step 1 -->
      <div class="flow-step">
        <div class="flow-step-num">1</div>
        <div class="flow-step-body">
          <div class="flow-step-title">ダウンロードしたPDFをCopilotに添付し、以下のプロンプトを入れる</div>
          <div style="font-size:12px; color:#ef4444; margin-top:6px; font-weight:500;">※GPT-5,2 Think Deeperを選択すること</div>
          <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
            <button id="copyPromptBtn" class="btn btn-primary btn-sm" style="flex:none;">
              <i data-lucide="copy" size="14"></i> プロンプトをコピー
            </button>
            <button id="editPromptBtn" class="btn btn-secondary btn-sm" style="flex:none;">
              <i data-lucide="pencil" size="14"></i> 編集
            </button>
            <div style="flex:1"></div>
            <a href="https://m365.cloud.microsoft/chat/?auth=2" target="_blank" rel="noopener" class="btn btn-secondary btn-sm" style="flex:none; text-decoration:none;">
              <i data-lucide="external-link" size="14"></i> Copilotを開く
            </a>
          </div>
          <div id="promptEditArea" class="hidden" style="margin-top:8px;">
            <textarea id="promptTextarea" class="form-control" rows="10" style="font-size:11px; resize:vertical; font-family:monospace;"></textarea>
            <div style="display:flex; gap:8px; margin-top:6px;">
              <button id="savePromptBtn" class="btn btn-primary btn-sm" style="flex:none;">
                <i data-lucide="check" size="14"></i> 保存
              </button>
              <button id="resetPromptBtn" class="btn btn-secondary btn-sm" style="flex:none;">
                <i data-lucide="rotate-ccw" size="14"></i> デフォルトに戻す
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Step 2 -->
      <div class="flow-step">
        <div class="flow-step-num">2</div>
        <div class="flow-step-body">
          <div class="flow-step-title">出力されたCSVテキストをコピーし、以下の入力欄にペーストする</div>
          <textarea id="csvInput" class="form-control" rows="5" placeholder="filename,工種（棟名）,施工階,施工部位,符号,位置&#10;example.jpg,選別処理棟,1階,スラブ,S3,23-24.D-E" style="font-size:11px; resize:vertical; margin-top:8px;"></textarea>
        </div>
      </div>
      <!-- Step 3 -->
      <div class="flow-step" style="border-bottom:none; padding-bottom:0;">
        <div class="flow-step-num">3</div>
        <div class="flow-step-body">
          <div class="flow-step-title">フォルダ振分ZIPをダウンロード</div>
          <button id="csvZipBtn" class="btn btn-success" disabled style="margin-top:8px;">
            <i data-lucide="folder-archive"></i> フォルダ振分ZIP保存
          </button>
          <div id="csvStatus" style="font-size:11px; color:var(--text-sub); margin-top:4px;"></div>
        </div>
      </div>
    </div>
    <div style="padding:12px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; background:var(--bg-modal-footer);">
      <button class="btn btn-secondary" style="width:auto;" onclick="closeModal('csvFlowModal')"> 閉じる</button>
    </div>
  </div>
</div>
<!-- JSファイルの読み込み -->
<script src="script.js"></script>

<!-- OpenCV.js: メインスクリプトの後ろで読み込む -->
<script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="window.onOpenCvReady && window.onOpenCvReady()"></script>
</body>
</html>
