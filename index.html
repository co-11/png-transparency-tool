<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNGÁ∑®ÈõÜ„Ç¢„Éó„É™</title>
    <style>
        /* ===== Reset & Variables ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --container-bg: #fff;
            --card-bg: #f5f5f5;
            --text: #333;
            --text-sub: #666;
            --text-muted: #888;
            --border: #ddd;
            --sidebar-bg: #f0f0f0;
            --item-bg: #fff;
            --item-hover: #e8e8e8;
            --input-bg: #fff;
            --drop-bg: #f8f9ff;
            --drop-hover: #eef1ff;
            --accent: #667eea;
            --accent-hover: #5a6fd6;
        }
        
        .dark {
            --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --container-bg: #1e1e2e;
            --card-bg: #2a2a3e;
            --text: #e0e0e0;
            --text-sub: #aaa;
            --text-muted: #777;
            --border: #444;
            --sidebar-bg: #252535;
            --item-bg: #2a2a3e;
            --item-hover: #3a3a4e;
            --input-bg: #2a2a3e;
            --drop-bg: #252535;
            --drop-hover: #2a2a3e;
        }

        /* ===== Base Layout ===== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s;
        }
        
        .app { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; }
        .main { flex: 1; background: var(--container-bg); border-radius: 16px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .sidebar { width: 280px; background: var(--sidebar-bg); border-radius: 16px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: calc(100vh - 40px); display: flex; flex-direction: column; }
        .hidden { display: none; }

        /* ===== Header ===== */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { color: var(--text); font-size: 24px; }
        .theme-btn { background: var(--card-bg); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 18px; transition: transform 0.2s; }
        .theme-btn:hover { transform: scale(1.1); }

        /* ===== Drop Zone ===== */
        .drop { border: 3px dashed var(--accent); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; background: var(--drop-bg); margin-bottom: 20px; transition: all 0.3s; }
        .drop:hover, .drop.dragover { background: var(--drop-hover); border-color: #764ba2; }
        .drop p { color: var(--text-sub); font-size: 16px; }
        .drop input { display: none; }

        /* ===== Tools Grid ===== */
        .tools { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .card { background: var(--card-bg); border-radius: 10px; padding: 12px; }
        .card h4 { margin-bottom: 8px; color: var(--text); font-size: 14px; }
        
        .row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .row label { font-size: 12px; color: var(--text-sub); }
        .row span { color: var(--text-sub); }
        
        .tol-row { display: flex; align-items: center; gap: 8px; width: 100%; }
        .tol-row label { flex-shrink: 0; font-size: 11px; color: var(--text-sub); }
        .tol-row input[type="range"] { flex: 1; }
        .tol-row .val { min-width: 24px; text-align: right; font-size: 11px; color: var(--text-sub); }

        /* ===== Form Controls ===== */
        input[type="range"] { height: 5px; border-radius: 3px; background: var(--border); -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--accent); cursor: pointer; }
        input[type="color"] { width: 32px; height: 26px; border: none; border-radius: 5px; cursor: pointer; }
        input[type="number"] { width: 65px; padding: 5px 7px; border: 2px solid var(--border); border-radius: 5px; font-size: 12px; background: var(--input-bg); color: var(--text); }
        input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); }

        /* ===== Canvas Area ===== */
        .canvas-area { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; }
        .canvas-wrap { text-align: center; }
        .canvas-wrap h3 { margin-bottom: 6px; color: var(--text); font-size: 13px; }
        canvas { max-width: 320px; max-height: 320px; border: 1px solid var(--border); border-radius: 8px; background: repeating-conic-gradient(#ccc 0% 25%, #fff 0% 50%) 50% / 14px 14px; }
        #srcCvs.pick { cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='none' stroke='%23667eea' stroke-width='2'/%3E%3Ccircle cx='12' cy='12' r='3' fill='%23667eea'/%3E%3C/svg%3E") 12 12, crosshair; }
        #srcCvs.crop { cursor: crosshair; }
        #srcCvs.select { cursor: crosshair; }
        .info { text-align: center; color: var(--text-muted); font-size: 11px; margin-bottom: 10px; }
        .mode-btns { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .mode-btn { padding: 6px 14px; font-size: 12px; background: var(--card-bg); color: var(--text); border: 2px solid transparent; }
        .mode-btn.active { border-color: var(--accent); background: var(--accent); color: #fff; }

        /* ===== Buttons ===== */
        .btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 9px 18px; font-size: 13px; border: none; border-radius: 7px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-apply { background: var(--accent); color: #fff; }
        .btn-apply:hover { background: var(--accent-hover); }
        .btn-reset { background: var(--card-bg); color: var(--text); }
        .btn-dl { background: linear-gradient(135deg, #11998e, #38ef7d); color: #fff; }
        .btn-dl:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17,153,142,0.4); }

        /* ===== Sidebar / History ===== */
        .sidebar h4 { font-size: 13px; color: var(--text-sub); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .history { display: flex; flex-direction: column; gap: 6px; overflow-y: auto; flex: 1; }
        .history-item { display: flex; align-items: center; gap: 8px; background: var(--item-bg); padding: 8px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; color: var(--text); transition: background 0.2s; }
        .history-item:hover { background: var(--item-hover); }
        .history-item.active { background: var(--accent); color: #fff; }
        .history-item.active .detail, .history-item.active .del { color: rgba(255,255,255,0.8); }
        .num { font-weight: bold; min-width: 18px; }
        .info-wrap { flex: 1; min-width: 0; }
        .label { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .detail { font-size: 10px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .del { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 3px 6px; border-radius: 4px; font-size: 12px; flex-shrink: 0; }
        .del:hover { background: #ff5252; color: #fff; }
        .del:disabled { opacity: 0.3; cursor: not-allowed; }

        /* ===== Responsive ===== */
        @media (max-width: 900px) {
            .app { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="main">
            <div class="header">
                <h1>üñºÔ∏è PNGÁ∑®ÈõÜ„Ç¢„Éó„É™</h1>
                <button class="theme-btn" id="theme" title="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø">üåô</button>
            </div>
            
            <div class="drop" id="drop">
                <p>üìÅ ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó / „ÇØ„É™„ÉÉ„ÇØ / Ctrl+V</p>
                <input type="file" id="file" accept="image/*">
            </div>

            <div class="hidden" id="editor">
                <div class="tools">
                    <div class="card">
                        <h4>üî≤ ÈÄèÈÅé</h4>
                        <div class="row"><label>Ëâ≤</label><input type="color" id="tColor" value="#ffffff"></div>
                        <div class="tol-row">
                            <label>Ë®±ÂÆπÂÄ§</label>
                            <input type="range" id="tTol" min="0" max="255" value="30">
                            <span class="val" id="tTolV">30</span>
                        </div>
                        <button class="btn-apply" id="applyT">ÈÅ©Áî®</button>
                    </div>

                    <div class="card">
                        <h4>üé® Ëâ≤ÁΩÆÊèõ</h4>
                        <div class="row">
                            <input type="color" id="rFrom" value="#000000">
                            <span>‚Üí</span>
                            <input type="color" id="rTo" value="#ff0000">
                        </div>
                        <div class="tol-row">
                            <label>Ë®±ÂÆπÂÄ§</label>
                            <input type="range" id="rTol" min="0" max="255" value="30">
                            <span class="val" id="rTolV">30</span>
                        </div>
                        <button class="btn-apply" id="applyR">ÈÅ©Áî®</button>
                    </div>

                    <div class="card">
                        <h4>ü™£ Â°ó„Çä„Å§„Å∂„Åó</h4>
                        <div class="row">
                            <label>Ëâ≤</label><input type="color" id="fColor" value="#ff0000">
                            <label>ÈÄèÊòé„ÅÆ„Åø</label><input type="checkbox" id="fOnly">
                        </div>
                        <button class="btn-apply" id="applyF">ÈÅ©Áî®</button>
                    </div>

                    <div class="card">
                        <h4>üìê Âá∫Âäõ„Çµ„Ç§„Ç∫</h4>
                        <div class="row">
                            <input type="number" id="outW" min="1" max="4096">
                            <span>√ó</span>
                            <input type="number" id="outH" min="1" max="4096" readonly>
                        </div>
                    </div>
                </div>

                <div class="mode-btns">
                    <button class="mode-btn active" id="modePick">üéØ „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº</button>
                    <button class="mode-btn" id="modeCrop">‚úÇÔ∏è „Éà„É™„Éü„É≥„Ç∞</button>
                    <button class="mode-btn" id="modeSelect">‚¨ö ÈÅ∏ÊäûÁØÑÂõ≤</button>
                </div>
                <p class="info" id="modeInfo">üí° „ÇØ„É™„ÉÉ„ÇØ„ÅßËâ≤„ÇíÂèñÂæó</p>

                <div class="canvas-area">
                    <div class="canvas-wrap"><h3>ÂÖÉÁîªÂÉè</h3><canvas id="srcCvs"></canvas></div>
                    <div class="canvas-wrap"><h3>Á∑®ÈõÜÂæå</h3><canvas id="dstCvs"></canvas></div>
                </div>

                <div class="btns">
                    <button class="btn-reset" id="reset">üîÑ „É™„Çª„ÉÉ„Éà</button>
                    <button class="btn-dl" id="dl">üíæ PNG„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                </div>
            </div>
        </div>

        <div class="sidebar hidden" id="sidebar">
            <h4>üìù Á∑®ÈõÜÂ±•Ê≠¥</h4>
            <div class="history" id="hist"></div>
        </div>
    </div>

    <script>
    (() => {
        // ===== DOM =====
        const $ = id => document.getElementById(id);
        const el = {
            drop: $('drop'), file: $('file'), editor: $('editor'), sidebar: $('sidebar'),
            srcCvs: $('srcCvs'), dstCvs: $('dstCvs'), hist: $('hist'), theme: $('theme'),
            tColor: $('tColor'), tTol: $('tTol'), tTolV: $('tTolV'),
            rFrom: $('rFrom'), rTo: $('rTo'), rTol: $('rTol'), rTolV: $('rTolV'),
            fColor: $('fColor'), fOnly: $('fOnly'),
            outW: $('outW'), outH: $('outH'),
            modePick: $('modePick'), modeCrop: $('modeCrop'), modeSelect: $('modeSelect'), modeInfo: $('modeInfo')
        };
        const srcCtx = el.srcCvs.getContext('2d');
        const dstCtx = el.dstCvs.getContext('2d');

        // ===== State =====
        let origImg = null, history = [], idx = -1, ratio = 1;
        let crop = { start: null, end: null, active: false, shift: false };
        let mode = 'pick'; // 'pick', 'crop', or 'select'
        let selection = null; // { x, y, w, h }
        let dark = localStorage.getItem('dark') === '1';

        // ===== Theme =====
        const setTheme = () => {
            document.body.classList.toggle('dark', dark);
            el.theme.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('dark', dark ? '1' : '0');
        };
        setTheme();
        el.theme.onclick = () => { dark = !dark; setTheme(); };

        // ===== Utils =====
        const hex2rgb = hex => {
            const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
        };
        const colorDist = (d, i, c) => Math.sqrt((d[i]-c.r)**2 + (d[i+1]-c.g)**2 + (d[i+2]-c.b)**2);
        const getCoords = (e, cvs) => {
            const r = cvs.getBoundingClientRect();
            return { x: (e.clientX - r.left) * cvs.width / r.width, y: (e.clientY - r.top) * cvs.height / r.height };
        };

        // ===== History =====
        const save = (label, detail = '') => {
            const state = dstCtx.getImageData(0, 0, el.dstCvs.width, el.dstCvs.height);
            history = history.slice(0, idx + 1);
            history.push({ data: state, label, detail, w: el.dstCvs.width, h: el.dstCvs.height, time: new Date().toLocaleTimeString() });
            idx = history.length - 1;
            renderHist();
            syncSrc();
        };

        const syncSrc = () => {
            const s = history[idx];
            el.srcCvs.width = s.w; el.srcCvs.height = s.h;
            srcCtx.putImageData(s.data, 0, 0);
        };

        const goTo = i => {
            if (i < 0 || i >= history.length) return;
            idx = i;
            const s = history[i];
            el.dstCvs.width = s.w; el.dstCvs.height = s.h;
            dstCtx.putImageData(s.data, 0, 0);
            ratio = s.w / s.h;
            el.outW.value = s.w; el.outH.value = s.h;
            renderHist();
            syncSrc();
        };

        const delState = i => {
            if (i === 0 || history.length <= 1) return;
            history.splice(i, 1);
            if (idx >= i) idx = Math.max(0, idx - 1);
            goTo(idx);
        };

        const renderHist = () => {
            el.hist.innerHTML = history.map((h, i) => `
                <div class="history-item ${i === idx ? 'active' : ''}" data-i="${i}">
                    <span class="num">${i + 1}</span>
                    <div class="info-wrap">
                        <div class="label">${h.label}</div>
                        <div class="detail">${h.detail} (${h.w}√ó${h.h}) ${h.time}</div>
                    </div>
                    <button class="del" data-i="${i}" ${i === 0 ? 'disabled' : ''}>‚úï</button>
                </div>
            `).join('');
            
            el.hist.querySelectorAll('.history-item').forEach(item => {
                item.onclick = e => { if (!e.target.classList.contains('del')) goTo(+item.dataset.i); };
            });
            el.hist.querySelectorAll('.del').forEach(btn => {
                btn.onclick = e => { e.stopPropagation(); delState(+btn.dataset.i); };
            });
        };

        // ===== File Load =====
        const load = file => {
            if (!file?.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => { origImg = img; init(img); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        const init = img => {
            el.srcCvs.width = el.dstCvs.width = img.width;
            el.srcCvs.height = el.dstCvs.height = img.height;
            srcCtx.drawImage(img, 0, 0);
            dstCtx.drawImage(img, 0, 0);
            ratio = img.width / img.height;
            el.outW.value = img.width; el.outH.value = img.height;
            history = []; idx = -1;
            save('ÂÖÉÁîªÂÉè', 'Ë™≠„ÅøËæº„Åø');
            el.editor.classList.remove('hidden');
            el.sidebar.classList.remove('hidden');
        };

        // ===== Drop Zone Events =====
        el.drop.ondragover = e => { e.preventDefault(); el.drop.classList.add('dragover'); };
        el.drop.ondragleave = () => el.drop.classList.remove('dragover');
        el.drop.ondrop = e => { e.preventDefault(); el.drop.classList.remove('dragover'); load(e.dataTransfer.files[0]); };
        el.drop.onclick = () => el.file.click();
        el.file.onchange = e => load(e.target.files[0]);
        document.onpaste = e => { for (const item of e.clipboardData.items) if (item.type.startsWith('image/')) { load(item.getAsFile()); break; } };

        // ===== Mode Switch =====
        const setMode = m => {
            mode = m;
            el.modePick.classList.toggle('active', m === 'pick');
            el.modeCrop.classList.toggle('active', m === 'crop');
            el.modeSelect.classList.toggle('active', m === 'select');
            el.srcCvs.classList.toggle('pick', m === 'pick');
            el.srcCvs.classList.toggle('crop', m === 'crop');
            el.srcCvs.classList.toggle('select', m === 'select');
            const info = { pick: 'üí° „ÇØ„É™„ÉÉ„ÇØ„ÅßËâ≤„ÇíÂèñÂæó', crop: 'üí° „Éâ„É©„ÉÉ„Ç∞„Åß„Éà„É™„Éü„É≥„Ç∞ÔºàShift: Ê≠£ÊñπÂΩ¢Ôºâ', select: 'üí° „Éâ„É©„ÉÉ„Ç∞„ÅßÈÅ∏ÊäûÁØÑÂõ≤„ÇíÊåáÂÆöÔºàÁ∑®ÈõÜ„Åå„Åù„ÅÆÁØÑÂõ≤„ÅÆ„ÅøÈÅ©Áî®Ôºâ' };
            el.modeInfo.textContent = info[m];
            if (m !== 'select') { selection = null; redrawSrc(); }
        };
        const redrawSrc = () => {
            if (idx < 0) return;
            srcCtx.putImageData(history[idx].data, 0, 0);
            if (selection) {
                srcCtx.strokeStyle = '#00cc66'; srcCtx.lineWidth = 2; srcCtx.setLineDash([6, 3]);
                srcCtx.strokeRect(selection.x, selection.y, selection.w, selection.h);
                srcCtx.setLineDash([]);
                srcCtx.fillStyle = 'rgba(0, 204, 102, 0.15)';
                srcCtx.fillRect(selection.x, selection.y, selection.w, selection.h);
            }
        };
        el.modePick.onclick = () => setMode('pick');
        el.modeCrop.onclick = () => setMode('crop');
        el.modeSelect.onclick = () => setMode('select');
        setMode('pick');
        // ===== Crop & Color Pick =====
        el.srcCvs.onmousedown = e => {
            if (mode === 'crop' || mode === 'select') { crop.start = getCoords(e, el.srcCvs); crop.active = true; crop.shift = e.shiftKey; }
        };
        el.srcCvs.onmousemove = e => {
            if ((mode !== 'crop' && mode !== 'select') || !crop.active) return;
            crop.shift = e.shiftKey;
            let end = getCoords(e, el.srcCvs);
            if (crop.shift) {
                const dx = end.x - crop.start.x, dy = end.y - crop.start.y;
                const size = Math.max(Math.abs(dx), Math.abs(dy));
                end.x = crop.start.x + size * Math.sign(dx);
                end.y = crop.start.y + size * Math.sign(dy);
            }
            crop.end = end;
            srcCtx.putImageData(history[idx].data, 0, 0);
            srcCtx.strokeStyle = mode === 'crop' ? '#ff4444' : '#00cc66'; srcCtx.lineWidth = 3; srcCtx.setLineDash([10, 5]);
            srcCtx.shadowColor = '#000'; srcCtx.shadowBlur = 2;
            srcCtx.strokeRect(crop.start.x, crop.start.y, crop.end.x - crop.start.x, crop.end.y - crop.start.y);
        };
        el.srcCvs.onmouseup = () => {
            srcCtx.setLineDash([]); srcCtx.shadowBlur = 0;
            if (crop.active && crop.end && Math.abs(crop.end.x - crop.start.x) > 10 && Math.abs(crop.end.y - crop.start.y) > 10) {
                const x = Math.round(Math.min(crop.start.x, crop.end.x));
                const y = Math.round(Math.min(crop.start.y, crop.end.y));
                const w = Math.round(Math.abs(crop.end.x - crop.start.x));
                const h = Math.round(Math.abs(crop.end.y - crop.start.y));
                if (mode === 'crop') {
                    const data = srcCtx.getImageData(x, y, w, h);
                    el.dstCvs.width = w; el.dstCvs.height = h;
                    dstCtx.putImageData(data, 0, 0);
                    ratio = w / h;
                    el.outW.value = w; el.outH.value = h;
                    save('„Éà„É™„Éü„É≥„Ç∞', `(${x},${y})‚Üí${w}√ó${h}`);
                } else if (mode === 'select') {
                    selection = { x, y, w, h };
                    redrawSrc();
                }
            }
            crop = { start: null, end: null, active: false };
        };

        el.srcCvs.onclick = e => {
            if (mode !== 'pick') return;
            const c = getCoords(e, el.srcCvs);
            const p = srcCtx.getImageData(c.x, c.y, 1, 1).data;
            const hex = '#' + [p[0], p[1], p[2]].map(v => v.toString(16).padStart(2, '0')).join('');
            el.tColor.value = hex;
            el.rFrom.value = hex;
        };

        // ===== Tool Controls =====
        el.tTol.oninput = () => el.tTolV.textContent = el.tTol.value;
        el.rTol.oninput = () => el.rTolV.textContent = el.rTol.value;
        el.outW.oninput = () => el.outH.value = Math.round((+el.outW.value || 1) / ratio);

        // ===== Apply Tools =====
        const inSelection = (px, py) => !selection || (px >= selection.x && px < selection.x + selection.w && py >= selection.y && py < selection.y + selection.h);
        $('applyT').onclick = () => {
            const c = hex2rgb(el.tColor.value), tol = +el.tTol.value;
            const img = dstCtx.getImageData(0, 0, el.dstCvs.width, el.dstCvs.height);
            const imgW = el.dstCvs.width;
            let cnt = 0;
            for (let i = 0; i < img.data.length; i += 4) {
                const px = (i / 4) % imgW, py = Math.floor((i / 4) / imgW);
                if (inSelection(px, py) && colorDist(img.data, i, c) <= tol) { img.data[i+3] = 0; cnt++; }
            }
            dstCtx.putImageData(img, 0, 0);
            const selInfo = selection ? ` [ÈÅ∏ÊäûÁØÑÂõ≤]` : '';
            save('ÈÄèÈÅé', `${el.tColor.value} Ë®±ÂÆπ${tol} ‚Üí ${cnt}px${selInfo}`);
        };

        $('applyR').onclick = () => {
            const fc = hex2rgb(el.rFrom.value), tc = hex2rgb(el.rTo.value), tol = +el.rTol.value;
            const img = dstCtx.getImageData(0, 0, el.dstCvs.width, el.dstCvs.height);
            const imgW = el.dstCvs.width;
            let cnt = 0;
            for (let i = 0; i < img.data.length; i += 4) {
                const px = (i / 4) % imgW, py = Math.floor((i / 4) / imgW);
                if (inSelection(px, py) && img.data[i+3] > 0 && colorDist(img.data, i, fc) <= tol) {
                    img.data[i] = tc.r; img.data[i+1] = tc.g; img.data[i+2] = tc.b; cnt++;
                }
            }
            dstCtx.putImageData(img, 0, 0);
            const selInfo = selection ? ` [ÈÅ∏ÊäûÁØÑÂõ≤]` : '';
            save('Ëâ≤ÁΩÆÊèõ', `${el.rFrom.value}‚Üí${el.rTo.value} ‚Üí ${cnt}px${selInfo}`);
        };

        $('applyF').onclick = () => {
            const c = hex2rgb(el.fColor.value), only = el.fOnly.checked;
            const img = dstCtx.getImageData(0, 0, el.dstCvs.width, el.dstCvs.height);
            const imgW = el.dstCvs.width;
            let cnt = 0;
            for (let i = 0; i < img.data.length; i += 4) {
                const px = (i / 4) % imgW, py = Math.floor((i / 4) / imgW);
                if (inSelection(px, py) && (only ? img.data[i+3] === 0 : img.data[i+3] > 0)) {
                    img.data[i] = c.r; img.data[i+1] = c.g; img.data[i+2] = c.b;
                    if (only) img.data[i+3] = 255;
                    cnt++;
                }
            }
            dstCtx.putImageData(img, 0, 0);
            const selInfo = selection ? ` [ÈÅ∏ÊäûÁØÑÂõ≤]` : '';
            save('Â°ó„Çä„Å§„Å∂„Åó', `${el.fColor.value} ${only ? 'ÈÄèÊòé„ÅÆ„Åø' : '‰∏çÈÄèÊòé'} ‚Üí ${cnt}px${selInfo}`);
        };

        // ===== Reset & Download =====
        $('reset').onclick = () => { if (origImg) init(origImg); };
        $('dl').onclick = () => {
            const w = +el.outW.value, h = +el.outH.value;
            const cvs = document.createElement('canvas');
            cvs.width = w; cvs.height = h;
            cvs.getContext('2d').drawImage(el.dstCvs, 0, 0, w, h);
            const a = document.createElement('a');
            a.download = 'edited.png';
            a.href = cvs.toDataURL('image/png');
            a.click();
        };
    })();
    </script>
</body>
</html>
